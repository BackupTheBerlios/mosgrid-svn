package de.mosgrid.dygraph;

import java.io.IOException;
import java.io.OutputStream;

import com.vaadin.Application;
import com.vaadin.ui.Button;
import com.vaadin.ui.Upload;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Upload.FailedEvent;
import com.vaadin.ui.Upload.Receiver;
import com.vaadin.ui.Upload.SucceededEvent;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.Notification;

import de.mosgrid.dygraph.ui.SimpleGraphViewer;
import de.mosgrid.dygraph.util.DataWithCustomErrorBars;
import de.mosgrid.dygraph.util.SimpleData;
import de.mosgrid.dygraph.util.parser.SimpleXVGParser;
import de.mosgrid.dygraph.widget.IData;

public class DygraphDemo extends Application implements Receiver {

	SimpleXVGParser parser;
	SimpleGraphViewer viewer;

	@Override
	public void init() {
		Window mainWindow = new Window("DygraphDemo");

		Button demoBtn = new Button("Demo");
		demoBtn.addListener(new Button.ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {

				viewer.getGraph().setData(new DemoData1());

			}
		});
		mainWindow.addComponent(demoBtn);

		Button demoBtn2 = new Button("Demo2");
		demoBtn2.addListener(new Button.ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {

				viewer.getGraph().setData(new DemoData2());

			}
		});
		mainWindow.addComponent(demoBtn2);
		final Upload xvgUpload = new Upload(null, this);
		xvgUpload.setImmediate(true);
		xvgUpload.setButtonCaption("Upload XVG");
		xvgUpload.setDescription("Please upload a *.xvg file");
		xvgUpload.addListener(new Upload.SucceededListener() {

			@Override
			public void uploadSucceeded(SucceededEvent event) {
				xvgUpload.setComponentError(null);
				IData data = parser.getData();
				viewer.getGraph().setData(data);
			}
		});
		xvgUpload.addListener(new Upload.FailedListener() {

			@Override
			public void uploadFailed(FailedEvent event) {
				Notification notif = new Notification("Please upload .xvg files only!", Notification.TYPE_ERROR_MESSAGE);
				getMainWindow().showNotification(notif);
				xvgUpload.setComponentError(null);

			}
		});
		mainWindow.addComponent(xvgUpload);

		viewer = new SimpleGraphViewer();
		mainWindow.addComponent(viewer);

		setMainWindow(mainWindow);
	}

	@Override
	public OutputStream receiveUpload(String filename, String mimeType) {
		OutputStream os = null;
		if (filename.endsWith(".xvg")) {
			parser = new SimpleXVGParser();
			os = new OutputStream() {
				private StringBuilder lineBuffer = new StringBuilder();
				private static final int newLineByte = '\n';

				@Override
				public void write(int b) throws IOException {
					if (b == newLineByte) {
						parser.parseLine(lineBuffer.toString());
						lineBuffer = new StringBuilder();
					} else {
						lineBuffer.append((char) b);
					}
				}
			};
		}
		return os;
	}

	public class DemoData1 extends SimpleData {
		private static final String values = "0.000,-282631.781250\n" + "1.000,-325651.156250\n"
				+ "2.000,-358315.250000\n" + "3.000,-369302.812500\n" + "5.000,-376356.218750\n"
				+ "6.000,-381311.062500\n" + "8.000,-384845.312500\n" + "10.000,-388196.625000\n"
				+ "11.000,-390327.968750\n" + "12.000,-393570.906250\n" + "13.000,-394278.500000\n"
				+ "14.000,-397327.187500\n" + "16.000,-399967.875000\n" + "18.000,-401516.156250\n"
				+ "19.000,-402131.062500\n" + "20.000,-403867.156250\n" + "22.000,-406647.343750\n"
				+ "23.000,-406849.250000\n" + "24.000,-410795.687500\n" + "26.000,-411950.812500\n"
				+ "27.000,-412852.500000\n" + "28.000,-413891.812500\n" + "29.000,-414451.156250\n"
				+ "30.000,-415235.218750\n" + "31.000,-415363.875000\n" + "32.000,-415567.687500\n"
				+ "34.000,-419326.750000\n" + "35.000,-420274.937500\n" + "36.000,-422551.625000\n"
				+ "38.000,-423637.937500\n" + "40.000,-424353.000000\n" + "41.000,-425019.281250\n"
				+ "42.000,-425633.187500\n" + "43.000,-426105.687500\n" + "44.000,-426554.281250\n"
				+ "45.000,-426630.562500\n" + "46.000,-426817.156250\n" + "48.000,-429135.687500\n"
				+ "50.000,-429809.937500\n" + "51.000,-430636.343750\n" + "52.000,-430703.062500\n"
				+ "53.000,-431527.031250\n" + "55.000,-432455.375000\n" + "56.000,-432596.687500\n"
				+ "57.000,-433788.468750\n" + "59.000,-434336.062500\n" + "60.000,-434625.062500\n"
				+ "61.000,-435208.000000\n" + "63.000,-435848.750000\n" + "64.000,-436423.968750\n"
				+ "65.000,-437170.156250\n" + "67.000,-437597.968750\n" + "68.000,-437989.062500\n"
				+ "69.000,-438429.406250\n" + "70.000,-438644.156250\n" + "71.000,-439060.625000\n"
				+ "73.000,-439730.625000\n" + "74.000,-440299.562500\n" + "75.000,-441120.187500\n"
				+ "77.000,-441473.750000\n" + "78.000,-441779.750000\n" + "79.000,-442105.125000\n"
				+ "80.000,-442295.718750\n" + "81.000,-442543.687500\n" + "82.000,-442553.250000\n"
				+ "83.000,-442593.500000\n" + "85.000,-443975.656250\n" + "86.000,-444065.437500\n"
				+ "87.000,-445468.718750\n" + "89.000,-445801.000000\n" + "90.000,-445817.937500\n"
				+ "91.000,-446192.093750\n" + "93.000,-446783.687500\n" + "94.000,-446817.875000\n"
				+ "95.000,-447598.593750\n" + "97.000,-447881.375000\n" + "98.000,-448024.937500\n"
				+ "99.000,-448310.468750\n" + "101.000,-448732.375000\n" + "102.000,-449060.718750\n"
				+ "103.000,-449586.156250\n" + "105.000,-449828.718750\n" + "106.000,-450030.750000\n"
				+ "107.000,-450266.750000\n" + "108.000,-450374.250000\n" + "109.000,-450571.843750\n"
				+ "111.000,-451069.187500\n" + "112.000,-451406.937500\n" + "113.000,-452039.562500\n"
				+ "115.000,-452243.093750\n" + "116.000,-452421.687500\n" + "117.000,-452589.812500\n"
				+ "118.000,-452701.531250\n" + "119.000,-452791.531250\n" + "121.000,-453365.250000\n"
				+ "122.000,-453835.843750\n" + "123.000,-454571.781250\n" + "125.000,-454739.187500\n"
				+ "126.000,-454912.343750\n" + "127.000,-455015.000000\n" + "128.000,-455146.812500\n"
				+ "130.000,-455556.562500\n" + "131.000,-455849.000000\n" + "132.000,-456503.750000\n"
				+ "134.000,-456653.750000\n" + "135.000,-456820.406250\n" + "136.000,-456904.187500\n"
				+ "137.000,-457046.531250\n" + "139.000,-457396.437500\n" + "140.000,-457669.500000\n"
				+ "141.000,-458122.125000\n" + "143.000,-458272.437500\n" + "144.000,-458406.062500\n"
				+ "145.000,-458532.375000\n" + "146.000,-458619.875000\n" + "147.000,-458695.625000\n"
				+ "148.000,-458696.562500\n" + "150.000,-459263.093750\n" + "151.000,-459443.531250\n"
				+ "152.000,-460313.437500\n" + "154.000,-460416.531250\n" + "155.000,-460528.531250\n"
				+ "156.000,-460570.593750\n" + "157.000,-460629.906250\n" + "159.000,-461068.156250\n"
				+ "160.000,-461219.125000\n" + "161.000,-461813.812500\n" + "163.000,-461920.343750\n"
				+ "164.000,-462029.812500\n" + "165.000,-462093.718750\n" + "166.000,-462162.000000\n"
				+ "168.000,-462499.250000\n" + "169.000,-462694.937500\n" + "170.000,-463255.375000\n"
				+ "172.000,-463350.968750\n" + "173.000,-463480.375000\n" + "174.000,-463507.718750\n"
				+ "175.000,-463632.750000\n" + "177.000,-463889.968750\n" + "178.000,-463977.562500\n"
				+ "179.000,-464307.437500\n" + "181.000,-464417.937500\n" + "182.000,-464498.187500\n"
				+ "183.000,-464603.406250\n" + "184.000,-464630.687500\n" + "185.000,-464710.750000\n"
				+ "187.000,-465015.375000\n" + "188.000,-465110.812500\n" + "189.000,-465492.750000\n"
				+ "191.000,-465587.531250\n" + "192.000,-465666.031250\n" + "193.000,-465742.312500\n"
				+ "194.000,-465776.937500\n" + "195.000,-465809.125000\n" + "197.000,-466157.937500\n"
				+ "198.000,-466278.687500\n" + "199.000,-466719.781250\n" + "201.000,-466797.937500\n"
				+ "202.000,-466879.437500\n" + "203.000,-466925.281250\n" + "204.000,-466972.500000\n"
				+ "206.000,-467239.812500\n" + "207.000,-467381.343750\n" + "208.000,-467825.312500\n"
				+ "210.000,-467894.250000\n" + "211.000,-467996.000000\n" + "212.000,-468010.625000\n"
				+ "213.000,-468109.937500\n" + "215.000,-468311.750000\n" + "216.000,-468363.312500\n"
				+ "217.000,-468619.968750\n" + "219.000,-468707.218750\n" + "220.000,-468765.625000\n"
				+ "221.000,-468849.875000\n" + "222.000,-468863.906250\n" + "223.000,-468931.250000\n"
				+ "225.000,-469169.875000\n" + "226.000,-469220.562500\n" + "227.000,-469518.937500\n"
				+ "229.000,-469594.625000\n" + "230.000,-469651.750000\n" + "231.000,-469715.125000\n"
				+ "232.000,-469733.531250\n" + "233.000,-469766.468750\n" + "235.000,-470041.031250\n"
				+ "236.000,-470097.187500\n" + "237.000,-470442.843750\n" + "239.000,-470505.812500\n"
				+ "240.000,-470564.687500\n" + "241.000,-470605.875000\n" + "242.000,-470633.187500\n"
				+ "244.000,-470857.218750\n" + "245.000,-471017.437500\n" + "246.000,-471397.375000\n"
				+ "248.000,-471452.125000\n" + "249.000,-471540.468750\n" + "250.000,-471542.312500\n"
				+ "251.000,-471636.187500\n" + "253.000,-471790.343750\n" + "254.000,-471815.062500\n"
				+ "255.000,-472007.468750\n" + "257.000,-472081.937500\n" + "258.000,-472124.375000\n"
				+ "259.000,-472202.187500\n" + "261.000,-472306.406250\n" + "262.000,-472405.687500\n"
				+ "263.000,-472530.125000\n" + "265.000,-472598.062500\n" + "266.000,-472659.750000\n"
				+ "267.000,-472731.593750\n" + "268.000,-472765.437500\n" + "269.000,-472837.250000\n"
				+ "271.000,-472951.000000\n" + "272.000,-473040.500000\n" + "273.000,-473178.468750\n"
				+ "275.000,-473243.750000\n" + "276.000,-473297.812500\n" + "277.000,-473364.187500\n"
				+ "278.000,-473392.062500\n" + "279.000,-473454.843750\n" + "281.000,-473582.000000\n"
				+ "282.000,-473664.937500\n" + "283.000,-473820.031250\n" + "285.000,-473881.625000\n"
				+ "286.000,-473930.250000\n" + "287.000,-473990.562500\n" + "288.000,-474014.187500\n"
				+ "289.000,-474065.156250\n" + "291.000,-474207.875000\n" + "292.000,-474286.562500\n"
				+ "293.000,-474461.781250\n" + "295.000,-474518.562500\n" + "296.000,-474564.687500\n"
				+ "297.000,-474615.625000\n" + "298.000,-474638.031250\n" + "299.000,-474674.812500\n"
				+ "301.000,-474834.875000\n" + "302.000,-474913.843750\n" + "303.000,-475111.437500\n"
				+ "305.000,-475162.656250\n" + "306.000,-475206.937500\n" + "307.000,-475248.656250\n"
				+ "308.000,-475270.937500\n" + "309.000,-475291.531250\n" + "311.000,-475471.031250\n"
				+ "312.000,-475556.062500\n" + "313.000,-475778.250000\n" + "315.000,-475823.656250\n"
				+ "316.000,-475867.500000\n" + "317.000,-475898.250000\n" + "318.000,-475923.125000\n"
				+ "319.000,-475925.781250\n" + "321.000,-476123.812500\n" + "322.000,-476225.218750\n"
				+ "323.000,-476471.250000\n" + "325.000,-476510.843750\n" + "326.000,-476555.406250\n"
				+ "327.000,-476575.312500\n" + "328.000,-476603.562500\n" + "330.000,-476747.250000\n"
				+ "331.000,-476808.718750\n" + "332.000,-477039.250000\n" + "334.000,-477075.250000\n"
				+ "335.000,-477130.500000\n" + "336.000,-477138.812500\n" + "337.000,-477192.125000\n"
				+ "339.000,-477303.687500\n" + "340.000,-477334.937500\n" + "341.000,-477474.062500\n"
				+ "343.000,-477522.812500\n" + "344.000,-477554.781250\n" + "345.000,-477603.125000\n"
				+ "346.000,-477610.906250\n" + "347.000,-477651.093750\n" + "349.000,-477779.875000\n"
				+ "350.000,-477808.062500\n" + "351.000,-477967.968750\n" + "353.000,-478011.937500\n"
				+ "354.000,-478043.500000\n" + "355.000,-478082.781250\n" + "356.000,-478090.625000\n"
				+ "357.000,-478117.125000\n" + "359.000,-478264.500000\n" + "360.000,-478289.718750\n"
				+ "361.000,-478474.125000\n" + "363.000,-478512.781250\n" + "364.000,-478544.687500\n"
				+ "365.000,-478574.187500\n" + "366.000,-478584.531250\n" + "367.000,-478594.218750\n"
				+ "369.000,-478762.625000\n" + "370.000,-478790.812500\n" + "371.000,-479001.718750\n"
				+ "373.000,-479034.812500\n" + "374.000,-479067.937500\n" + "375.000,-479087.468750\n"
				+ "376.000,-479101.031250\n" + "378.000,-479235.531250\n" + "379.000,-479304.187500\n"
				+ "380.000,-479527.531250\n" + "382.000,-479556.312500\n" + "383.000,-479607.437500\n"
				+ "385.000,-479662.406250\n" + "386.000,-479712.843750\n" + "387.000,-479777.781250\n"
				+ "388.000,-479780.562500\n" + "389.000,-479854.187500\n" + "391.000,-479916.718750\n"
				+ "392.000,-479934.062500\n" + "393.000,-480014.718750\n" + "395.000,-480061.375000\n"
				+ "396.000,-480090.687500\n" + "397.000,-480139.625000\n" + "398.000,-480146.718750\n"
				+ "399.000,-480192.687500\n" + "401.000,-480278.093750\n" + "402.000,-480302.718750\n"
				+ "403.000,-480422.937500\n" + "405.000,-480459.312500\n" + "406.000,-480492.343750\n"
				+ "407.000,-480520.406250\n" + "408.000,-480544.343750\n" + "409.000,-480555.312500\n"
				+ "410.000,-480559.812500\n" + "412.000,-480712.875000\n" + "413.000,-480749.812500\n"
				+ "414.000,-480938.625000\n" + "416.000,-480966.937500\n" + "417.000,-480996.875000\n"
				+ "418.000,-481013.000000\n" + "419.000,-481027.250000\n" + "421.000,-481143.625000\n"
				+ "422.000,-481200.375000\n" + "423.000,-481390.312500\n" + "425.000,-481415.500000\n"
				+ "426.000,-481460.187500\n" + "427.000,-481460.218750\n" + "428.000,-481507.500000\n"
				+ "430.000,-481589.343750\n" + "431.000,-481600.875000\n" + "432.000,-481702.562500\n"
				+ "434.000,-481741.000000\n" + "435.000,-481762.656250\n" + "436.000,-481803.343750\n"
				+ "438.000,-481857.250000\n" + "439.000,-481908.687500\n" + "440.000,-481974.343750\n"
				+ "442.000,-482010.687500\n" + "443.000,-482042.312500\n" + "444.000,-482080.468750\n"
				+ "445.000,-482097.468750\n" + "446.000,-482136.812500\n" + "448.000,-482196.906250\n"
				+ "449.000,-482241.750000\n" + "450.000,-482314.343750\n" + "452.000,-482349.625000\n"
				+ "453.000,-482378.125000\n" + "454.000,-482415.312500\n" + "455.000,-482429.156250\n"
				+ "456.000,-482466.062500\n" + "458.000,-482532.062500\n" + "459.000,-482572.031250\n"
				+ "460.000,-482653.343750\n" + "462.000,-482687.812500\n" + "463.000,-482713.718750\n"
				+ "464.000,-482749.187500\n" + "465.000,-482760.062500\n" + "466.000,-482792.562500\n"
				+ "468.000,-482867.281250\n" + "469.000,-482903.187500\n" + "470.000,-482994.750000\n"
				+ "472.000,-483027.687500\n" + "473.000,-483052.187500\n" + "474.000,-483084.343750\n"
				+ "475.000,-483094.187500\n" + "476.000,-483120.500000\n" + "478.000,-483205.250000\n"
				+ "479.000,-483238.093750\n" + "480.000,-483342.781250\n" + "482.000,-483373.781250\n"
				+ "483.000,-483397.375000\n" + "484.000,-483425.062500\n" + "485.000,-483434.000000\n"
				+ "486.000,-483453.562500\n" + "488.000,-483549.843750\n" + "489.000,-483580.062500\n"
				+ "490.000,-483699.562500\n" + "492.000,-483727.718750\n" + "493.000,-483750.687500\n"
				+ "494.000,-483773.562500\n" + "495.000,-483782.875000\n" + "496.000,-483793.812500\n"
				+ "498.000,-483902.843750\n" + "499.000,-483933.812500\n" + "500.000,-484069.781250\n";

		public DemoData1() {
			super();
			setTitle("Potential Energy");
			setxLabel("Time (ps)");
			setyLabel("(kJ/mol)");
			addSeriesName("Potential");
			addValueLine(values);
		}
	}

	public class DemoData2 extends DataWithCustomErrorBars {
		private static final String values = "1,8;10;13\n" + "2,9;11;12\n"+ "3,7;9;10.5\n"+ "5,7.5;9;9.5\n";

		public DemoData2() {
			super();
			setTitle("Data with error bars");
			setxLabel("X");
			setyLabel("Y");
			addSeriesName("S1");
			addValueLine(values);
		}
	}

}
